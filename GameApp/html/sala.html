<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/ui.css" rel="stylesheet" />
		<link href="../css/room/index.css" rel="stylesheet" />
		<link href="../css/sala/index.css" rel="stylesheet" />
		<script src="../js/frame/template-web.js"></script>
		
	</head>

	<body>
		
		<div class="mui-content" id="refreshContainer">
			
		    <!--runner ad begin-->
		    <div class="runnerAd">
		    	<!--runner image begin-->
					<div class="runnerImage">
						<!--image begin-->
				    	<div class="mui-slider">
						  <div class="mui-slider-group" >
						    <div class="mui-slider-item"><a href="javascript:void(0)" id="getLimitRoom"><img src="../images/find_room.png"/></a></div>
						  </div>
						  <div class="area" id="area">
							<span >系统正在加载,请稍后……</span>
								<!--<input name="checkbox"  type="checkbox" checked>0.1元体验区
								<input name="checkbox" type="checkbox" checked>1元体验区
								<input name="checkbox"  type="checkbox" checked>2元体验区
								<input name="checkbox"  type="checkbox" checked>5元体验区-->
							
						  </div>
						  <script id="areaTemplate" type="text/html">
							{{each list as item index}}
								<input name="checkbox" value="{{item.subareaId}}" type="checkbox" class="{{index == 2 ? 'break' : ''}}" checked>{{item.limitPrice}}区
							{{/each}}
						</script>
						</div>
				    	<!--image end-->
					</div> 
				<!--runner image end-->
				
				<div class="form-placeholder-10"></div>
				<div class="form-placeholder-5"></div>
				
		    </div>
		    <!--runner ad end-->
			
			
		    <!--content begin-->
		    <ul id="list" class="mui-table-view list">
				<span class="loading" id="loading-text">系统正在加载,请稍后……</span> 
			</ul>
			<script id="template" type="text/html">
				{{each list as item index}}
					<li name="room-item"  class="mui-table-view-cell mui-media" data-code="{{item.roomCode}}" data-name="{{item.name}}">
				        <a href="javascript:;" name="item" data-code="{{item.roomCode}}"  data-name="{{item.name}}">
				            <img class="mui-media-object mui-pull-left" src="../images/house.png">
				            <div class="mui-media-body">
		                		{{item.name}}
				                <p class='mui-ellipsis info'>
				                	<span class="mui-badge mui-badge-success mui-badge-inverted my-badge-success">房间ID: {{item.roomCode}}</span>
				                	<span class="mui-badge mui-badge-danger   mui-badge-inverted">人气: {{item.personCount}}</span>
				                </p>
				            </div> 
				           <span class="mui-badge mui-badge-warning mui-badge-badge" style="right: 70px;">{{item.parentPrice}}元区</span>
				           {{@item.statusHtml}} 
				        </a>
				    </li>
				{{/each}}
			</script>
			<!--content end-->
			 <!--bottom navigation begin-->
			<div class="bottom-navigation-style"></div>
		    <!--bottom navigation end-->
		</div>
		
		
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/home/index.js"></script>
		<script src="../js/room/index.js"></script>
		
		<script type="text/javascript">
			var gDoc;
			var pages = window.config.pages;
			
			(function($, doc){
				gDoc = doc;
				
				$.init({
					pullRefresh : {
					    container:"#refreshContainer",//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					    down : {
					      style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					      color:'#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
					      height:'50px',//可选,默认50px.下拉刷新控件的高度,
					      range:'100px', //可选 默认100px,控件可下拉拖拽的范围
					      offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
					      auto: true,//可选,默认false.首次加载自动上拉刷新一次
					      contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
					      contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
					      contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					      callback: refresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					    }
				  	}
				});
				
				$.plusReady(function(){
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");
					
					var currentWebView = plus.webview.currentWebview();
					
					currentWebView.addEventListener("show", function(){
						refresh();
					})
					
				})
				
			})(mui, document);
			
			function refresh(callback){
				home.getLevelSubareas({}, function(data){
					if(data == null || data.code != 200) return plus.nativeUI.toast("加载游戏分区失败");
					var html = template("areaTemplate", {
						list: data.data
					}); 
					gDoc.getElementById("area").innerHTML = html;
					
					
					
					gDoc.getElementById("getLimitRoom").addEventListener("tap", function(){
						var checkList = gDoc.getElementsByName("checkbox");
						var idJoin = "";
						
						for (var i = 0; i < checkList.length; i++) {
							
							if(checkList[i].checked != null && checkList[i].checked == true){
								idJoin += checkList[i].value;
								if((i+1) < checkList.length) idJoin += ",";
							}
							
						}
						if(idJoin == "") idJoin = "0";
						
						room.getLimitRoom({"subareasId": idJoin}, function(data){
							
							if(data.code == 500 || data.code == 300){
								plus.nativeUI.toast("匹配失败"); 
								return false;
							}
							
							if(data.code == 400){ 
								plus.nativeUI.toast(data.msg);
								return false;
							}
							
							plus.nativeUI.toast("匹配成功");
							
							var roomCode = data.msg.roomCode;
							var name = data.msg.name;
						
						
							// 加入房间
							plus.nativeUI.confirm("确定要加入【" +roomCode + " - " + name+"】房间吗？", function(e){
								if(e.index == 0){
									var localCache = plus.storage.getItem('userInfo');
									if(localCache != null && localCache.length > 0){
										room.joinRoom({
											"token": JSON.parse(localCache).token.toString(),
											"roomCode": roomCode
										}, function(data){
											if(data == null || data.code == null || data.code == 500  || data.code == 300){
												plus.nativeUI.toast("加入房间失败");
												return false;
											}
		                					
		                					if(data.code == 400){
		                						if(data.msg == "已存在") data.msg = "您已是此房间的成员";
												plus.nativeUI.toast(data.msg);
												return false;
											}
		                					
											plus.nativeUI.toast("加入成功");
											
											mui.openWindow({
							                    url: "/html/room-detail.html",
							                    id: "room-detail",
							                    preload: false,
							                    waiting: {
							                        autoShow: true,
						                          title:'正在加载...'
							                    },
							                    extras:{
							                    	"title": roomCode + " - " + name,
													"room_code": roomCode
											    },
											    createNew:true
							    
							                });
										}, function(){
											
										});
									}
									
								}
							}, ["取消", "确定"])
						
						
						}, function(){
							
						})
					})
				}, function(){});
				
				
				var localCache = plus.storage.getItem('userInfo');
				if(!(localCache != null && localCache.length > 0)) return false; 
				room.getAllRoomList({}, function(data){
					if(gDoc.getElementById("loading-text") != null)	gDoc.getElementById("loading-text").innerText = "暂时还没有游戏房间";

					mui('#refreshContainer').pullRefresh().endPulldown();

					if(data == null || data.code != 200) return plus.nativeUI.toast("加载列表失败");
					
					for (var i = 0; i < data.data.length; i++) {
						var item = data.data[i];
						//状态(0=未开始,1=已就绪,2=已开始,3=已暂停,4=已结束,5=已结算,6=已失效)
						switch (item.status){
							case 0:
								item.statusHtml = '<span class="mui-badge mui-badge-outlined">未开始</span>';
								break;
							case 1:
								item.statusHtml = '<span class="mui-badge mui-badge-primary">已就绪</span>';
								break;
							case 2:
								item.statusHtml = '<span class="mui-badge mui-badge-success">游戏中</span>';
								break;
							case 3:
								item.statusHtml = '<span class="mui-badge">已暂停</span>';
								break;
							case 4:
								item.statusHtml = '<span class="mui-badge mui-badge-danger ">已结束</span>';
								break;
							case 5:
								item.statusHtml = '<span class="mui-badge mui-badge-royal ">已结算</span>';
								break;
							case 6:
								item.statusHtml = '<span class="mui-badge ">已失效</span>';
								break;
						}

					}
					
					if(data.data.length == 0) {
						gDoc.getElementById("list").innerHTML = '<span class="loading" id="loading-text">暂时还没有游戏房间</span>';
						return;
					}
					
					var html = template("template", {
						list: data.data
					}); 
					gDoc.getElementById("list").innerHTML = html; 
					
					var roomItems = gDoc.getElementsByName("item");
					for (var i = 0; i < roomItems.length; i++) {
						var roomItem = roomItems[i];
						
						roomItem.addEventListener("tap", function(){ 
							var roomCode = this.getAttribute("data-code");
							var name =this.getAttribute("data-name");
						
						
							// 加入房间
							plus.nativeUI.confirm("确定要加入此房间吗？", function(e){
								if(e.index == 0){
									var localCache = plus.storage.getItem('userInfo');
									if(localCache != null && localCache.length > 0){
										room.joinRoom({
											"token": JSON.parse(localCache).token.toString(),
											"roomCode": roomCode
										}, function(data){
											if(data == null || data.code == null || data.code == 500  || data.code == 300){
												plus.nativeUI.toast("加入房间失败");
												return false;
											}
		                					
		                					if(data.code == 400){
		                						if(data.msg == "已存在") data.msg = "您已是此房间的成员";
												plus.nativeUI.toast(data.msg);
												return false;
											}
		                					
											plus.nativeUI.toast("加入成功");
											
											mui.openWindow({
							                    url: "/html/room-detail.html",
							                    id: "room-detail",
							                    preload: false,
							                    waiting: {
							                        autoShow: true,
						                          title:'正在加载...'
							                    },
							                    extras:{
							                    	"title": roomCode + " - " + name,
													"room_code": roomCode
											    },
											    createNew:true
							    
							                });
										}, function(){
											
										});
									}
									
								}
							}, ["取消", "确定"])
						
						
							
						}, false)
					}
					
				}, function(){
					plus.nativeUI.toast("加载列表失败");
					gDoc.getElementById("loading-text").innerText = "加载列表失败";
					mui('#refreshContainer').pullRefresh().endPulldown();
					
				})
			}
		</script>
	</body>

</html>