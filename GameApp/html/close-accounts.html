<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/ui.css" rel="stylesheet" />
		<link href="../css/room/closeAccounts.css" rel="stylesheet" />
		
	</head>

	<body>
		<header class="mui-bar mui-bar-nav my-title" >
			<a class="mui-action-back mui-icon mui-icon-arrowleft mui-pull-left" style="color: #fff;"></a>
			<h1 class="mui-title my-title-color" id="title">结算</h1>
		</header>
		
		<div class="mui-content">
		 	<div class="form-placeholder-50"></div>
			
			
			<div id="typeSelector" class="typeSelector">
				<input type="hidden" id="type" value=""/>
				<span style="
					    display: block;
					    line-height: 90px;
					    text-align: center;
					    width: 85%;
					    margin: 0 auto;
					    color: #c8c8c8;
					    font-size: 21px;
					">请选择您本局游戏的结果</span>
				
				<span name="typeSelector" class="standings" tabindex="0">
					大获全胜
				</span>
				<div class="form-placeholder-30"></div>
				<span name="typeSelector" class="beRouted" tabindex="1">
					惨烈失败
				</span>
			</div>
			
			
			<!--content begin-->
				<div id="content" style="display: none;">
						
					<!--grade begin-->
					<div class="form-item form-item-full">
						<input type="number" class="form-input" id="grade" maxlength="8" placeholder="请输入战绩" value=""/>
					</div>
					<!--grade end-->
					
					<div class="form-placeholder-20"></div>
					<div class="form-item">
						<button id='toCloseAccountsButton' class="mui-btn mui-btn-block mui-btn-orange">结&nbsp;&nbsp;算</button>
					</div>
				</div>
			<!--content end-->
		</div>
		
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/app.js"></script> 
		<script src="../js/room/index.js"></script> 
		<script type="text/javascript">
			var pages = window.config.pages;
			 
			(function($, doc){
				$.init({
					statusBarStyle: "light",
					statusBarBackground: '#FE532A'
				});
				
				$.plusReady(function(){
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");
					
					var self = plus.webview.currentWebview();
					var beforeSelf = self.self;
					var roomCode = self.room_code;
					
					// 选择结果
					var typeSelectorList = doc.getElementsByName("typeSelector");
					for (var i = 0; i < typeSelectorList.length; i++) {
						typeSelectorList[i].addEventListener("tap", function(){
							var tabindex = this.getAttribute("tabindex");
							doc.getElementById("type").value = tabindex;
							doc.getElementById("typeSelector").style.display="none"
							doc.getElementById("content").style.display="block"
						})
					}
					
					var toCloseAccountsButton = doc.getElementById("toCloseAccountsButton"),
						grade = doc.getElementById("grade");
						
					toCloseAccountsButton.addEventListener("tap", function(){
						toCloseAccountsButton.disabled = true;
						toCloseAccountsButton.classList.add("disabled");
						document.activeElement.blur();
						
						var type = doc.getElementById("type").value;
						var gradeValue = grade.value;
						if(doc.getElementById("grade").value == null || doc.getElementById("grade").value.length == 0) {
							toCloseAccountsButton.disabled = false;
							toCloseAccountsButton.classList.remove("disabled");
							return plus.nativeUI.toast("请输入成绩");
						}
						if(type == 1) gradeValue = gradeValue - (gradeValue * 2)
						
						console.log("成绩:" + parseFloat(gradeValue))
						
						var localCache = plus.storage.getItem('userInfo');
						if(localCache != null && localCache.length > 0){
							var param = {
								"token": JSON.parse(localCache).token.toString(),
								"roomCode": parseInt(roomCode),
								"grade": parseFloat(gradeValue)
							};
							
							room.closeAccounts(param, function(data){
								toCloseAccountsButton.disabled = false;
								toCloseAccountsButton.classList.remove("disabled");
						
								if(data.code == 500 || data.code == 300){
									plus.nativeUI.toast("申请失败"); 
									return false;
								}
								
								if(data.code == 400){ 
									if(data.msg == "已存在") data.msg = "请不要重复申请";
									plus.nativeUI.toast(data.msg);
									return false;
								}
								
								plus.nativeUI.toast("申请成功");
								$.openWindow({
									url: 'room.html',
									id: 'room',
									preload: true,
									show: {
										aniShow: 'pop-in',
										duration: 200
									},
									styles: {
										popGesture: 'hide'
									},
									waiting: {
										title: "正在加载...",
										autoShow: true
									}
								});
								
								for (var i = 0 ; i < pages.length ; i ++) {
									if (i != 2) { 
										plus.webview.hide(pages[i].id, "fade-out", 200);
									}
								}
								
								
								plus.webview.getWebviewById("room-detail-" + roomCode).close();
								plus.webview.currentWebview().close();
								
							}, function(){
								toCloseAccountsButton.disabled = false;
								toCloseAccountsButton.classList.remove("disabled");
								plus.nativeUI.toast("申请失败");
							});
						}
						
					})
				});

			})(mui, document)
			 
			  
		</script>
	</body>

</html>