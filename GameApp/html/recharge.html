<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/ui.css" rel="stylesheet" />
		<link href="../css/room/closeAccounts.css" rel="stylesheet" />
		<link href="../css/home/recharge.css" rel="stylesheet" />
		
	</head>

	<body>
		<header class="mui-bar mui-bar-nav my-title" >
			<a class="mui-action-back mui-icon mui-icon-arrowleft mui-pull-left" style="color: #fff;"></a>
			<h1 class="mui-title my-title-color" id="title">充值中心</h1>
		</header>
		
		<div class="mui-content">
		 	<div class="form-placeholder-50"></div>

			<div class="form-item">
				<label style="color:red;font-size: 14px;">转账时请在转账备注下填写注册的手机号</label>
		 		<div class="form-placeholder-30"></div>
		 		<div class="form-item form-item-full">
					<input type="number" class="form-input" id="amount" style="text-align: center;"  maxlength="8" placeholder="请输入充值金额" value=""/>
				</div>
				<button id='alipayButton' class="mui-btn mui-btn-block mui-btn-orange">去支付宝充值</button>
		 		<div class="form-placeholder-20"></div>
				<button id='payButton' class="mui-btn mui-btn-block mui-btn-orange">我已充值</button>
				<!--<a id="alipayButton" class="mui-btn mui-btn-block mui-btn-orange" style="color:#fff" href="alipays://platformapi/startapp?saId=10000007&qrcode=https://qr.alipay.com/FKX01971FVU2LCLFRYARF4">去支付宝充值</a>-->
			</div>
			
			<div class="form-placeholder-20"></div>
			
			<div class="info">
				<p>如果没有前往支付宝支付页面<br/>请点击下面的二维码保存到相册扫一扫支付</p>
				<img id="qcode" class="msg-content-image" src="#"/>
				<div class="form-placeholder-10"></div>
				<p>注意：<br/>目前充值由人工客服代理<br/>到账后会有短消息提醒您！</p> 
				<p>遇到支付问题联系客服！</p> 
			</div>
			
		</div>
		
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/app.js"></script> 
		<script src="../js/home/index.js"></script> 
		<script type="text/javascript">
			var pages = window.config.pages;
			var groupInfo ;
			var qrcode ;
			
			(function($, doc){
				$.init({
					statusBarStyle: "light",
					statusBarBackground: '#fe5a2f'
				});
				
				$.plusReady(function(){
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");
					
					groupInfo = JSON.parse(plus.storage.getItem("groupInfo"));
					var self = plus.webview.currentWebview();
					var beforeSelf = self.self;
					var roomCode = self.room_code;
					
					
					plus.webview.currentWebview().addEventListener("show", function(){
						console.log(groupInfo.payQRCodeUrl)
						doc.getElementById("qcode").src = groupInfo.payQRCodeUrl;
						 
					})
							
					doc.getElementById("payButton").addEventListener("tap",function(){
						if(document.getElementById("amount").value == null || document.getElementById("amount").value.length == 0) {
							plus.nativeUI.closeWaiting();
							return plus.nativeUI.toast("请输入充值金额"); 
						}
						
						var localCache = plus.storage.getItem('userInfo');
						if(localCache == null || localCache.length == 0) return plus.nativeUI.toast("请重新登录"); 
						var param = {
							"token": JSON.parse(localCache).token.toString(),
							"amount": parseFloat(document.getElementById("amount").value) 
						};
						plus.nativeUI.showWaiting( "正在核对金额……" );
						
						home.recharge(param, function(data){
							if(data.code == 500 || data.code == 300){
								plus.nativeUI.toast("充值失败"); 
								return false;
							}
							
							if(data.code == 400){ 
								plus.nativeUI.toast(data.msg);
								return false;
							}
							
							/*var url = "intent://platformapi/startapp?saId=10000007&" +
				            "clientVersion=3.7.0.0718&qrcode=https%3A%2F%2Fqr.alipay.com%2F" + urlCode + "%3F_s" +
				            "%3Dweb-other&_t=1472443966571#Intent;" +
				            "scheme=alipayqr;package=com.eg.android.AlipayGphone;end";
	
							var mContext = plus.android.runtimeMainActivity();
							var Intent = plus.android.importClass('android.content.Intent');
							var intent = new Intent();
							intent.setClassName("io.dcloud.HBuilder",'io.dcloud.PandoraEntry');
							mContext.startActivity(intent);
							
							var Uri = plus.android.importClass("android.net.Uri");
							var Intent = plus.android.importClass("android.content.Intent");
							var callIntent = Intent.parseUri(url,Intent.URI_INTENT_SCHEME);
							plus.android.runtimeMainActivity().startActivity(callIntent);*/
							
							plus.nativeUI.toast("已通知客服，审核后会给您发送短消息！");
							
							plus.nativeUI.closeWaiting();
							
							 
						}, function(){
							plus.nativeUI.closeWaiting();
							plus.nativeUI.toast("服务器开小差了,请您稍后重试!");
						})
						
						
					})
					
						plus.nativeUI.closeWaiting();
					
					doc.getElementById("alipayButton").addEventListener("tap",function(){
						
						var urlCode = groupInfo.payCode;
						plus.nativeUI.showWaiting( "准备前往支付页面……" );
						if(document.getElementById("amount").value == null || document.getElementById("amount").value.length == 0) {
							plus.nativeUI.closeWaiting();
							return plus.nativeUI.toast("请输入充值金额"); 
						}
						plus.runtime.openURL(encodeURI("alipays://platformapi/startapp?saId=10000007&qrcode=https://qr.alipay.com/" + urlCode));
						plus.nativeUI.closeWaiting();
					})
					  
					doc.getElementById("qcode").addEventListener("tap", function(){
						plus.nativeUI.showWaiting( "正在保存二维码" );
						console.log(groupInfo.payQRCodeUrl)
						var dtask = plus.downloader.createDownload(
								groupInfo.payQRCodeUrl, 
								{},
								function(d, status) {
									// 下载完成
									if(status == 200) {
										plus.nativeUI.closeWaiting();
										console.log("Download success: " + d.filename);
				
										plus.gallery.save( d.filename, function () {
											plus.nativeUI.toast( "保存成功");
										});
				
									} else {
										plus.nativeUI.closeWaiting();
										console.log("Download failed: " + status);
									}
								});
							dtask.start();
					})
					
				});

			})(mui, document)
			
		</script>
	</body>

</html>