<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/ui.css" rel="stylesheet" />
		<link href="../css/room/index.css" rel="stylesheet" />
		<script src="../js/frame/template-web.js"></script>
		
	</head>
 
	<body>
		
		<div class="mui-content" id="refreshContainer">
		    <!--content begin-->
		    <ul id="list" class="mui-table-view">
				<span class="loading" id="loading-text">系统正在加载,请稍后……</span> 
			</ul>
			<script id="template" type="text/html">
				{{each list as item index}}
					<li name="room-item"  class="mui-table-view-cell mui-media" data-code="{{item.roomCode}}" data-name="{{item.name}}">
				        <a href="javascript:;" name="item" data-code="{{item.roomCode}}"  data-name="{{item.name}}">
				            <img class="mui-media-object mui-pull-left" src="../images/house.png">
				            <div class="mui-media-body">
		                		{{item.name}}
				                <p class='mui-ellipsis info'>
				                	<span class="mui-badge mui-badge-success mui-badge-inverted my-badge-success">房间ID: {{item.roomCode}}</span>
				                	<span class="mui-badge mui-badge-danger   mui-badge-inverted">人气: {{item.personCount}}</span>
				                </p>
				            </div> 
				           <span class="mui-badge mui-badge-warning mui-badge-badge" style="right: 70px;display: {{(item.isOwner == null || item.isOwner == 0) ? 'none': 'block'}};">拥有者</span>
				           {{@item.statusHtml}} 
				        </a>
				    </li>
				{{/each}}
			</script>
			<!--content end-->
			 <!--bottom navigation begin-->
			<div class="bottom-navigation-style"></div>
		    <!--bottom navigation end-->
		</div>
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/wss.js"></script>
		<script src="../js/room/index.js"></script>
		
		<script type="text/javascript">
			var gDoc;
			var pages = window.config.pages;
			
			(function($, doc){
				gDoc = doc;
				
				$.init({
					pullRefresh : {
					    container:"#refreshContainer",//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					    down : {
					      style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					      color:'#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
					      height:'50px',//可选,默认50px.下拉刷新控件的高度,
					      range:'100px', //可选 默认100px,控件可下拉拖拽的范围
					      offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
					      auto: true,//可选,默认false.首次加载自动上拉刷新一次
					      contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
					      contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
					      contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					      callback: refresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					    }
				  	}
				});
				
				$.plusReady(function(){
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");
					
					var currentWebView = plus.webview.currentWebview();
					
					currentWebView.addEventListener("show", function(){ 
						refresh();
					})
					
					
				})
				
			})(mui, document);
			
			
			function refresh(callback){
				var localCache = plus.storage.getItem('userInfo');
				if(!(localCache != null && localCache.length > 0)) return false; 
				room.getRoomList({
					"token": JSON.parse(localCache).token.toString()
				}, function(data){
					mui('#refreshContainer').pullRefresh().endPulldown();
					
					if(gDoc.getElementById("loading-text") != null)	gDoc.getElementById("loading-text").innerText = "您还没有创建或加入房间";
		
		
					if(data == null || data.code != 200) return plus.nativeUI.toast("加载列表失败");
					
					for (var i = 0; i < data.data.length; i++) {
						var item = data.data[i];
						//状态(0=未开始,1=已就绪,2=已开始,3=已暂停,4=已结束,5=已结算,6=已失效)
						switch (item.status){
							case 0:
								item.statusHtml = '<span class="mui-badge mui-badge-outlined">未开始</span>';
								break;
							case 1:
								item.statusHtml = '<span class="mui-badge mui-badge-primary">已就绪</span>';
								break;
							case 2:
								item.statusHtml = '<span class="mui-badge mui-badge-success">游戏中</span>';
								break;
							case 3:
								item.statusHtml = '<span class="mui-badge">已暂停</span>';
								break;
							case 4:
								item.statusHtml = '<span class="mui-badge mui-badge-danger ">已结束</span>';
								break;
							case 5:
								item.statusHtml = '<span class="mui-badge mui-badge-royal ">已结算</span>';
								break;
							case 6:
								item.statusHtml = '<span class="mui-badge ">已失效</span>';
								break;
						}

					}
					
					if(data.data.length == 0) {
						gDoc.getElementById("list").innerHTML = '<span class="loading" id="loading-text">您还没有创建或加入房间</span>';
						return;
					}
					
					var html = template("template", {
						list: data.data
					}); 
					gDoc.getElementById("list").innerHTML = html; 
					
					var roomItems = gDoc.getElementsByName("item");
					
					for (var i = 0; i < roomItems.length; i++) {
						var roomItem = roomItems[i];
						
						
						roomItem.addEventListener("tap", function(e){
							e.stopPropagation();
							
							var roomCode = this.getAttribute("data-code");
							var name =this.getAttribute("data-name"); 
										
							// 构建聊天业务CHAT 
							
							
							var reChatHand,
								activeHand;
							
							window.CHAT = {
								socket: null,
								init: function() {
									console.log("初始化wss");
									if (window.WebSocket) {
										
										// 如果当前的状态已经连接，那就不需要重复初始化websocket
										if (CHAT.socket != null 
											&& CHAT.socket != undefined 
											&& CHAT.socket.readyState == WebSocket.OPEN) {
												console.log("wss已连接");
											return false;
										}
										
										console.log("创建wss连接");
										
										CHAT.socket = new WebSocket(config.wss);
										CHAT.socket.onopen = CHAT.wsopen,
										CHAT.socket.onclose = CHAT.wsclose,
										CHAT.socket.onerror = CHAT.wserror,
										CHAT.socket.onmessage = CHAT.wsmessage;
									} else {
										mui.alert("手机设备过旧，请升级手机设备...");
									}
								},
								close: function(){
									if(activeHand != null) clearInterval(activeHand);
									if(CHAT != null && CHAT.socket != null) CHAT.socket.close();
									console.log("主动关闭心跳和连接")
								},
								chat: function(msg) {
									console.log("发送消息：" + msg);
									
									// 如果当前websocket的状态是已打开，则直接发送， 否则重连
									if (CHAT.socket != null 
											&& CHAT.socket != undefined  
											&& CHAT.socket.readyState == WebSocket.OPEN) {
											console.log("直连websocket：" + msg);
			
											CHAT.socket.send(msg);
									} else {
										// 重连websocket
										console.log("重连websocket：" + msg);
										
										clearInterval(reChatHand);
										reChatHand = setTimeout("CHAT.initAndRetry('" + msg + "')", 30000);
									}
								},
								initAndRetry: function(msg) {
									console.log("重新发送消息：" + msg);
									CHAT.init();
									CHAT.socket.send(msg);
								},
								reChat: function(msg) {
									console.log("重新发送消息：" + msg);
									CHAT.socket.send(msg);
								},
								wsopen: function() {
									console.log("websocket连接已建立...");
									var me = JSON.parse(plus.storage.getItem('userInfo'));
									// 构建ChatMsg
									var chatMsg = new wss.ChatMsg(me.userId, roomCode, null, null);
									// 构建DataContent
									var dataContent = new wss.DataContent(wss.CONNECT, chatMsg, null);
									// 发送websocket
									CHAT.chat(JSON.stringify(dataContent));
									
									console.log("发送socket数据包:" + JSON.stringify(dataContent));
									
									
									// 定时发送心跳
									clearInterval(activeHand);
									activeHand = setInterval("CHAT.keepalive()", 30000);
								},
								wsmessage: function(e) {
									console.log("收到消息：" + e.data);
									
									var data = JSON.parse(e.data);
									var msg = data.chatMsg.msg;
									console.log(data.chatMsg.msg)
									
									var chatWebview = plus.webview.getWebviewById("room-detail-" + roomCode);
									
									if(chatWebview != null){
										if(msg.indexOf("系统消息") != -1){
											msg =  msg.replace("系统消息","");
											console.log("推送系统消息：" + msg);
											chatWebview.evalJS("recvMessageFromRoom('" + msg + "')");
										}else{
											chatWebview.evalJS("receiveMsg('" + msg + "')");
										}
							 			chatWebview.evalJS("resizeScreen()");
									}
									
							 		
								},
								wsclose: function() {
									console.log("连接关闭...");
								},
								wserror: function() {
									console.log("发生错误...");
								},
								keepalive: function() {
									// 构建对象
									var dataContent = new wss.DataContent(wss.KEEPALIVE, null, null);
									// 发送心跳
									console.log("发送心跳" +JSON.stringify(dataContent))
									CHAT.chat(JSON.stringify(dataContent));
								}
							};
							
							
							CHAT.init();
							
							mui.openWindow({
				                url: "/html/room-detail.html",
				                id: "room-detail-" + roomCode,
				                preload: false,
				                waiting: {
				                    autoShow: true,
				                  title:'正在加载...'
				                },
				                extras:{
				                	"title": roomCode + " - " + name,
									"room_code": roomCode
							    },
							    createNew:true
				
				           }); 
							
							
						});
						 	 
					}
					
					
					
				}, function(){
					mui('#refreshContainer').pullRefresh().endPulldown();
					plus.nativeUI.toast("加载列表失败");
					gDoc.getElementById("loading-text").innerText = "加载列表失败";
					
					
				})
			}
			 
		</script>
	</body>

</html>