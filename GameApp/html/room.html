<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/ui.css" rel="stylesheet" />
		<link href="../css/room/index.css" rel="stylesheet" />
		<script src="../js/frame/template-web.js"></script>
		
	</head>
 
	<body>
		
		<div class="mui-content" id="refreshContainer">
		    <!--content begin-->
		    <ul id="list" class="mui-table-view">
				<span class="loading" id="loading-text">系统正在加载,请稍后……</span> 
			</ul>
			<script id="template" type="text/html">
				{{each list as item index}}
					<li name="room-item"  class="mui-table-view-cell mui-media" data-code="{{item.roomCode}}" data-name="{{item.name}}">
				        <a href="javascript:;" name="item" data-code="{{item.roomCode}}"  data-name="{{item.name}}">
				            <img class="mui-media-object mui-pull-left" src="../images/house.png">
				            <div class="mui-media-body">
		                		{{item.name}}
				                <p class='mui-ellipsis info'>
				                	<span class="mui-badge mui-badge-success mui-badge-inverted my-badge-success">房间ID: {{item.roomCode}}</span>
				                	<span class="mui-badge mui-badge-danger   mui-badge-inverted">人气: {{item.personCount}}</span>
				                </p>
				            </div> 
				           <span class="mui-badge mui-badge-warning mui-badge-badge" style="right: 70px;display: {{(item.isOwner == null || item.isOwner == 0) ? 'none': 'block'}};">拥有者</span>
				           {{@item.statusHtml}} 
				        </a>
				    </li>
				{{/each}}
			</script>
			<!--content end-->
			 <!--bottom navigation begin-->
			<div class="bottom-navigation-style"></div>
		    <!--bottom navigation end-->
		</div>
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/room/index.js"></script>
		
		<script type="text/javascript">
			var gDoc;
			var pages = window.config.pages;
			
			(function($, doc){
				gDoc = doc;
				
				$.init({
					pullRefresh : {
					    container:"#refreshContainer",//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					    down : {
					      style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					      color:'#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
					      height:'50px',//可选,默认50px.下拉刷新控件的高度,
					      range:'100px', //可选 默认100px,控件可下拉拖拽的范围
					      offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
					      auto: true,//可选,默认false.首次加载自动上拉刷新一次
					      contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
					      contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
					      contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					      callback: refresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					    }
				  	}
				});
				
				$.plusReady(function(){
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");
					
					var currentWebView = plus.webview.currentWebview();
					
					currentWebView.addEventListener("show", function(){
						console.log("刷新")
						refresh();
					})
					
					// 构建聊天业务CHAT
					window.CHAT = {
						socket: null,
						init: function() {
							if (window.WebSocket) {
								
								// 如果当前的状态已经连接，那就不需要重复初始化websocket
								if (CHAT.socket != null 
									&& CHAT.socket != undefined 
									&& CHAT.socket.readyState == WebSocket.OPEN) {
									return false;
								}
								
								CHAT.socket = new WebSocket(config.wss);
								CHAT.socket.onopen = CHAT.wsopen,
								CHAT.socket.onclose = CHAT.wsclose,
								CHAT.socket.onerror = CHAT.wserror,
								CHAT.socket.onmessage = CHAT.wsmessage;
							} else {
								alert("手机设备过旧，请升级手机设备...");
							}
						},
						chat: function(msg) {
							
							// 如果当前websocket的状态是已打开，则直接发送， 否则重连
							if (CHAT.socket != null 
									&& CHAT.socket != undefined  
									&& CHAT.socket.readyState == WebSocket.OPEN) {
									CHAT.socket.send(msg);
							} else {
								// 重连websocket
								CHAT.init();
								setTimeout("CHAT.reChat('" + msg + "')", "1000");
							}
							// 渲染快照列表进行展示
							//loadingChatSnapshot();
						},
						reChat: function(msg) {
							console.log("消息重新发送...");
							CHAT.socket.send(msg);
						},
						wsopen: function() {
							console.log("websocket连接已建立...");
							
							var me = app.getUserGlobalInfo();
							// 构建ChatMsg
							var chatMsg = new app.ChatMsg(me.id, null, null, null);
							// 构建DataContent
							var dataContent = new app.DataContent(app.CONNECT, chatMsg, null);
							// 发送websocket
							CHAT.chat(JSON.stringify(dataContent));
							
							// 每次连接之后，获取用户的未读未签收消息列表
							fetchUnReadMsg();
							
							// 定时发送心跳
							setInterval("CHAT.keepalive()", 10000);
						},
						wsmessage: function(e) {
							console.log("接受到消息：" + e.data);
							var chatWebview = plus.webview.getWebviewById("room-detail-379520");
					 		chatWebview.evalJS("receiveMsg('" + e.data + "')");
					 		
					 		
						},
						wsclose: function() {
							console.log("连接关闭...");
						},
						wserror: function() {
							console.log("发生错误...");
						},
						/*signMsgList: function(unSignedMsgIds) {
							// 构建批量签收对象的模型
							var dataContentSign = new app.DataContent(app.SIGNED,
																	  null,
																	  unSignedMsgIds);
							// 发送批量签收的请求
							CHAT.chat(JSON.stringify(dataContentSign));
						},
						keepalive: function() {
							// 构建对象
							var dataContent = new app.DataContent(app.KEEPALIVE, null, null);
							// 发送心跳
							CHAT.chat(JSON.stringify(dataContent));
							
							// 定时执行函数
							fetchUnReadMsg();
							fetchContactList();
						}*/
					};
					
					
				})
				
			})(mui, document);
			
			
			function refresh(callback){
				var localCache = plus.storage.getItem('userInfo');
				if(!(localCache != null && localCache.length > 0)) return false; 
				room.getRoomList({
					"token": JSON.parse(localCache).token.toString()
				}, function(data){
					mui('#refreshContainer').pullRefresh().endPulldown();
					
					if(gDoc.getElementById("loading-text") != null)	gDoc.getElementById("loading-text").innerText = "您还没有创建或加入房间";
		
		
					if(data == null || data.code != 200) return plus.nativeUI.toast("加载列表失败");
					
					for (var i = 0; i < data.data.length; i++) {
						var item = data.data[i];
						//状态(0=未开始,1=已就绪,2=已开始,3=已暂停,4=已结束,5=已结算,6=已失效)
						switch (item.status){
							case 0:
								item.statusHtml = '<span class="mui-badge mui-badge-outlined">未开始</span>';
								break;
							case 1:
								item.statusHtml = '<span class="mui-badge mui-badge-primary">已就绪</span>';
								break;
							case 2:
								item.statusHtml = '<span class="mui-badge mui-badge-success">游戏中</span>';
								break;
							case 3:
								item.statusHtml = '<span class="mui-badge">已暂停</span>';
								break;
							case 4:
								item.statusHtml = '<span class="mui-badge mui-badge-danger ">已结束</span>';
								break;
							case 5:
								item.statusHtml = '<span class="mui-badge mui-badge-royal ">已结算</span>';
								break;
							case 6:
								item.statusHtml = '<span class="mui-badge ">已失效</span>';
								break;
						}

					}
					
					if(data.data.length == 0) {
						gDoc.getElementById("list").innerHTML = '<span class="loading" id="loading-text">您还没有创建或加入房间</span>';
						return;
					}
					
					var html = template("template", {
						list: data.data
					}); 
					gDoc.getElementById("list").innerHTML = html; 
					
					var roomItems = gDoc.getElementsByName("item");
					for (var i = 0; i < roomItems.length; i++) {
						var roomItem = roomItems[i];
						
						roomItem.addEventListener("tap", function(){ 
							var roomCode = this.getAttribute("data-code");
							var name =this.getAttribute("data-name"); 
							mui.openWindow({
			                    url: "/html/room-detail.html",
			                    id: "room-detail-" + roomCode,
			                    preload: false,
			                    waiting: {
			                        autoShow: true,
		                          title:'正在加载...'
			                    },
			                    extras:{
			                    	"title": roomCode + " - " + name,
									"room_code": roomCode
							    },
							    createNew:true
			    
			                });
						}, false)
					}
					
				}, function(){
					mui('#refreshContainer').pullRefresh().endPulldown();
					plus.nativeUI.toast("加载列表失败");
					gDoc.getElementById("loading-text").innerText = "加载列表失败";
					
					
				})
			}
		</script>
	</body>

</html>