<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/ui.css" />
		<link rel="stylesheet" href="../css/home/index.css" />
		<script src="../js/frame/template-web.js"></script>
		
	</head>

	<body>
		
		
		<div class="mui-content" id="refreshContainer">
		    
		    <!--runner ad begin-->
		    <div class="runnerAd">
		    	<!--runner image begin-->
					<div class="runnerImage">
						<!--image begin-->
				    	<div class="mui-slider">
						  <div class="mui-slider-group" id="runnerImage">
						    
						  </div>
						  <!--小圆点-->
						  <div class="mui-slider-indicator">
			                <div class="mui-indicator mui-active"></div>
			                <div class="mui-indicator"></div>
			                <div class="mui-indicator"></div>
		            	  </div>
						</div>
				    	<!--image end-->
					</div>
					<script id="runnerImageTemplate" type="text/html">
						{{each list as value index}}
						    <div class="mui-slider-item"><a href="#"><img src="{{value}}" alt="{{index}}" /></a></div>
						{{/each}}
					</script>
				<!--runner image end-->
				
				<div class="form-placeholder-10"></div>
				<div class="form-placeholder-5"></div>
				
		    	<!--text ad begin-->
		    	<div class="textAd">
		    		<span class="mui-icon mui-icon-chatbubble mui-pull-left icon"></span>
		    		<span class="text" id="topTextAd">金币100枚以上可每隔180分钟领取房卡30张哟！</span>
		    	</div>
		    	<!--text ad end-->
		    </div>
		    <!--runner ad end-->

			<div class="form-placeholder-10 form-placeholder-gray"></div>
			<div class="form-placeholder-5 form-placeholder-gray"></div>
			
			<!--container begin-->
			<div class="container">
				<!--small navigation begin-->
				<div class="small-navigation">
					<span class="left">快速入门</span>
					<span class="right">HOT</span>
				</div>
				<!--small navigation end-->
				
				<!--finance begin-->
				<div class="finance">
					<div class="recharge" id="recharge">
						<span id="centerLeftAdTitle">免费房卡不够用？</span>
						<p id="centerLeftAdDesc">充值金币特价房卡享不停</p>
						<button>立刻充值</button>
					</div>
					
					<div class="withdraw" id="withdraw">
						<span id="centerRightAdTitle">赢了游戏来领钱啦~</span>
						<p id="centerRightAdDesc">秒结算！真金白银带回家</p>
						<button>我要提现</button>
					</div>
				</div>
				<!--finance begin-->
				
				
				<!--room card begin-->
				<div class="roomCard">
					<!--image begin-->
					<div class="image">
						<img src="../images/roomCardAd.png" alt="" />
					</div>
					<!--image end-->
					
					<!--content begin-->
					<div class="content" id="getRoomCard">
						<span class="title" id="bottomAdTitle">免费领取熊猫麻将房卡</span>
						<p id="bottomAdDesc">多种玩法，快来大战三百回合~</p>
						<span class="mui-icon mui-icon-person icon"></span>
						<span class="personNum">982652</span>
					</div>
					<!--content end-->
				</div>
				<!--room card end-->

				<!--subareas begin-->
				<ul id="subareas" class="subareas"></ul>
				<script id="subareasTemplate" type="text/html">
					{{each list as item index}}
					    <li name="subareas-item" data-id="{{item.subareaId}}" >
							<img src="{{item.backgroundImage}}"  alt="{{item.name}}" />
						</li>
					{{/each}}
				</script>
				<!--subareas end-->
				
				<!--popular begin-->
				<div class="popular">
					<span>把我推荐给你的朋友吧</span>
					<span class="mui-icon mui-icon-arrowdown icon"></span>
					<img id="centerBottomAdQCode" src="../images/QRCode.png" alt="" />
				</div>
				<!--popular end-->
				
			</div>
			<!--container end-->
		    
		    <!--bottom navigation begin-->
			<div class="bottom-navigation-style"></div>
		    <!--bottom navigation end-->
		</div>
		
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/app.js"></script>
		<script src="../js/home/index.js"></script>
		
		<script type="text/javascript">
			var gDoc;
			var gallery = mui('.mui-slider');
			var bindMessageClick = 0;
			var getMessageTimer = null;
			
			(function($, doc){
				
				gDoc = doc;
				
				$.init({
					pullRefresh : {
					    container:"#refreshContainer",//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					    down : {
					      style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					      color:'#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
					      height:'50px',//可选,默认50px.下拉刷新控件的高度,
					      range:'100px', //可选 默认100px,控件可下拉拖拽的范围
					      offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
					      auto: true,//可选,默认false.首次加载自动上拉刷新一次
					      contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
					      contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
					      contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					      callback: refresh //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					    }
				  	}
				});
			 	
				$.plusReady(function(){
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");  
					
					// 推送消息被点击
						if(bindMessageClick == 0) {
							console.log("注册推送消息事件");
							
							plus.push.addEventListener("click", function(){
								console.log("推送消息被点击!");
								bindMessageClick = 1;
								if(plus.webview.getWebviewById("messages") != null) plus.webview.getWebviewById("messages").close();
								mui.openWindow({
				                    url: "/html/messages.html",
				                    id: "messages",
				                    preload: false,
				                    waiting: {
				                        autoShow: true,
				                      title:'正在加载...'
				                    },
				                    createNew: true
				                });
						});
					}
					
					plus.webview.currentWebview().addEventListener("show", function(){
						console.log("页面刷新"); 
					})
					
					doc.getElementById("recharge").addEventListener("tap", function(){
						mui.openWindow({
		                    url: "recharge.html",
		                    id: "recharge",
		                    preload: false,
		                    waiting: {
		                        autoShow: true,
	                          title:'正在加载...'
		                    },
						    createNew:true
		    
		                });
					})
					
					
					
					/**
					 * 申请提现
					 */
					doc.getElementById("withdraw").addEventListener("tap", function(){
						mui.openWindow({
		                    url: "withdraw.html",
		                    id: "withdraw",
		                    preload: false,
		                    waiting: {
		                        autoShow: true,
	                          title:'正在加载...'
		                    },
						    createNew:true
		    
		                });
					})
					 
					 /**
					  * 领取房卡
					  */
					doc.getElementById("getRoomCard").addEventListener("tap", function(){
						var localCache = plus.storage.getItem('userInfo');
						if(localCache != null && localCache.length > 0){
							console.log(localCache)
							mui.confirm("确定为熊猫麻将ID为：" + JSON.parse(localCache).pandaId + "\r\n账户领取30张房卡吗？(金币>100)", "免费房卡", ["确定", "取消"], function(e){
								if(e.index == 0){
									
									home.getRoomCard({
										"token": JSON.parse(localCache).token.toString(),
										"pandaId": JSON.parse(localCache).pandaId.toString(),
									}, function(data){
										if(data == null || data.code == 500 || data.code == 300) return plus.nativeUI.toast("领取失败");
										if(data.code == 400) return plus.nativeUI.toast(data.msg);
		
										plus.nativeUI.toast("已提交申请，请等待客服审核！");
									}, function(){
										plus.nativeUI.toast("操作失败");
									}) 
								}
							})
						}else{
							plus.nativeUI.toast("请重新登录");
						}
						
					})
					
				})
				
			})(mui, document);
			 

			
			/**
			 * 下拉刷新回调
			 */
			function refresh(){
				plus.nativeUI.closeWaiting();
				
				var topTextAd = gDoc.getElementById("topTextAd"),
					centerBottomAdQCode = gDoc.getElementById("centerBottomAdQCode"),
					bottomAdTitle = gDoc.getElementById("bottomAdTitle"),
					bottomAdDesc = gDoc.getElementById("bottomAdDesc"),
					centerLeftAdTitle = gDoc.getElementById("centerLeftAdTitle"),
					centerLeftAdDesc = gDoc.getElementById("centerLeftAdDesc"),
					centerRightAdTitle = gDoc.getElementById("centerRightAdTitle"),
					centerRightAdDesc = gDoc.getElementById("centerRightAdDesc");
				
				readMessage();
				
				
				// 加载聚合AD信息
				home.getGroupInformation({}, function(data){
					mui('#refreshContainer').pullRefresh().endPulldown();
					
					if(data == null || data.code != 200) return plus.nativeUI.toast("获取首页信息失败");
					
					var html = template("runnerImageTemplate", {
						list: data.msg.topRunnerAds
					}); 
					gDoc.getElementById("runnerImage").innerHTML = html;
					 
					
					
					// 加载动态AD内容
					topTextAd.innerText = data.msg.topTextAd;
					centerBottomAdQCode.style.src = data.msg.centerBottomAdQCode;
					
					
					bottomAdTitle.innerText = data.msg.centerBottomAdTitle;
					bottomAdDesc.innerText = data.msg.centerBottomAdDesc;
					
					
					centerLeftAdTitle.innerText = data.msg.centerLeftAdTitle;
					centerLeftAdDesc.innerText = data.msg.centerLeftAdDesc;
					
					centerRightAdTitle.innerText = data.msg.centerRightAdTitle;
					centerRightAdDesc.innerText = data.msg.centerRightAdDesc;
					 
					gallery.slider({
					  interval:5000//自动轮播周期，若为0则不自动播放，默认为0；
					});
					
					plus.storage.setItem("groupInfo", JSON.stringify(data.msg));
				}, function(){
					plus.nativeUI.toast("获取首页信息失败");
					mui('#refreshContainer').pullRefresh().endPulldown();
					
				});
			
				// 加载游戏分区 
				home.getLevelSubareas({}, function(data){
					if(data == null || data.code != 200 || data.count == 0) return plus.nativeUI.toast("获取游戏分区失败");
					var html = template("subareasTemplate", {
						list: data.data
					});
					gDoc.getElementById("subareas").innerHTML = html;
					
					
					// 创建房间事件
					var items = gDoc.getElementsByName("subareas-item");
					
					for (var i = 0; i < items.length; i++) {
						items[i].addEventListener("tap", function(){
							var id = this.getAttribute("data-id");
							mui.openWindow({
			                    url: "/html/create-room.html",
			                    id: "create-room",
			                    preload: false,
			                    waiting: {
			                        autoShow: true,
		                          title:'正在加载...'
			                    },
			                    extras:{
									subareaId: id
							    },
							    createNew:true
			    
			                });
						})
					}
					
				},function(){
					plus.nativeUI.toast("获取游戏分区失败");
				});
			 
			}
			
			function readMessage(){
				console.log("拉取短信息心跳线程");
				var localCache = plus.storage.getItem('userInfo');
				if(!(localCache != null && localCache.length > 0)) return false; 
				app.getMessageNotification({
					"token": JSON.parse(localCache).token.toString()
				}, function(data){
					if(data == null || data.code == null || data.code == 500 || data.code == 400) return console.log("拉取短消息通知列表失败");
					if(data.code == 300) return console.log("拉取短消息通知列表失败，具体原因：" + data.msg);
					for (var i = 0; i < data.data.length; i++) {
						if(data.data[i].state == 0){
							plus.push.createMessage("您有一条新的短消息: " + data.data[i].message);
						}
					} 
				}, function(){});
				
				
			}
			 
		</script>
		 
	</body>

</html>