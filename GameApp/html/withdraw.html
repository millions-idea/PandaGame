<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/ui.css" rel="stylesheet" />
		<link href="../css/room/closeAccounts.css" rel="stylesheet" />
		<link href="../css/home/recharge.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav my-title" >
			<a class="mui-action-back mui-icon mui-icon-arrowleft mui-pull-left" style="color: #fff;"></a>
			<h1 class="mui-title my-title-color" id="title">申请提现</h1>
		</header>
		
		<div class="mui-content">
		 	<div class="form-placeholder-50"></div>
			
			<div class="form-item form-item-full">
				<label for="withdrawAmount">可提现余额</label>
				<input type="number" class="form-input" style="text-align: center;" disabled="disabled" id="withdrawAmount" maxlength="8"  placeholder="..." value=""/>
			</div>
			
			<div class="form-item form-item-full">
				<input type="number" class="form-input" id="amount" style="text-align: center;"  maxlength="8" placeholder="请输入提现金额" value=""/>
			</div>
			
			
			<div class="form-placeholder-20"></div>
			<div class="form-item">
				<button id='withdrawButton' class="mui-btn mui-btn-block mui-btn-orange">申请提现</button>
			</div>
			<div class="form-placeholder-20"></div>
			
			<div class="info">
				<p>预计两小时内到账，工作时间 09:00-22:00</p> 
			</div>
		</div>
		
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/app.js"></script> 
		<script src="../js/home/index.js"></script> 
		<script type="text/javascript">
			var pages = window.config.pages;
			 
			(function($, doc){
				$.init({
					statusBarStyle: "light",
					statusBarBackground: '#fe5a2f'
				});
				
				$.plusReady(function(){
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");
					
					var self = plus.webview.currentWebview();
					var beforeSelf = self.self;
					
					
					 
					var withdrawButton = doc.getElementById("withdrawButton"),
						withdrawAmountInput = doc.getElementById("withdrawAmount"),
						amountInput = doc.getElementById("amount");
						
						 
					// 刷新
					plus.webview.currentWebview().addEventListener("show", function(){
						var localCache = plus.storage.getItem('userInfo');
						if(localCache != null && localCache.length > 0){
							var param = {
								"token": JSON.parse(localCache).token.toString()
							};
							
							home.getWithdrawAmount(param, function(data){
								if(data.code == 500 || data.code == 300){
									plus.nativeUI.toast("查询可用余额失败"); 
									return false;
								}
								
								if(data.code == 400){ 
									plus.nativeUI.toast(data.msg);
									return false;
								}
								
								withdrawAmountInput.value = parseFloat(data.msg);
							}, function(){
								plus.nativeUI.toast("查询可用余额失败");
							})
							
							app.getUserDetailInfo(param, function(data){
								if(data == null || data.code == null || data.code == 500 || data.code == 400) return plus.nativeUI.toast("刷新失败");
								plus.storage.setItem('userInfo', JSON.stringify(data.msg));
								
								// 判断是否绑定了财务账户
								localCache = plus.storage.getItem('userInfo');
								if(JSON.parse(localCache).financeId == null){
									plus.nativeUI.confirm("您还没有绑定支付宝账号，请先绑定", function(e){
										if(e.index == 0){
											// 打开绑定支付宝账户页面
											mui.openWindow({
									            url: "/html/bind-finance-account.html",
									            id: "bind-finance-account",
									            preload: false,
									            show: {
													aniShow: 'pop-in',
													duration: 200
												},
												styles: {
													popGesture: 'hide'
												},
												waiting: {
													title: "正在加载...",
													autoShow: true
												}
									       }); 
									       
									       
										}
									}, {
										title: "新用户提醒",
										buttons: [ "去绑定", "取消"]
									});
								}
								
							}, function(){
								plus.nativeUI.toast("服务器开小差了,请您稍后重试!");
							});
						
							
							
						}
					
						
					})
						
					withdrawButton.addEventListener("tap", function(){
						var localCache = plus.storage.getItem('userInfo');
						if(localCache != null && localCache.length > 0){
							var param = {
								"token": JSON.parse(localCache).token.toString(),
								"amount": parseFloat(amountInput.value) 
							};
							
							home.withdraw(param, function(data){
								if(data.code == 500 || data.code == 300){
									if(data.msg.indexOf("余额不足")){
										plus.nativeUI.toast("余额不足"); 
									}else{
										plus.nativeUI.toast("申请失败"); 
									}
									return false;
								}
								
								if(data.code == 400){
									if(data.msg == "已存在") data.msg = "您已申请过同笔提现";
									plus.nativeUI.toast(data.msg);
									return false;
								}
								
								plus.nativeUI.toast("申请成功");
								
								$.openWindow({
									url: 'my.html',
									id: 'my',
									preload: false,
									show: {
										aniShow: 'pop-in',
										duration: 200
									},
									styles: {
										popGesture: 'hide'
									},
									waiting: {
										title: "正在加载...",
										autoShow: true
									}
								});
								
								for (var i = 0 ; i < pages.length ; i ++) {
									if (i != 3) {
										console.log(pages[i].id)
										plus.webview.hide(pages[i].id, "fade-out", 200);
									}
								}
								
								plus.webview.currentWebview().close();
								
							}, function(){
								plus.nativeUI.toast("服务器开小差了,请您稍后重试!");
							});
						}
						
					})
				});

			})(mui, document)
			 
			  
		</script>
	</body>

</html>