<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" /> 
		<link rel="stylesheet" href="../css/ui.css" />
		<link rel="stylesheet" href="../css/my/index.css" />
		<script src="../js/frame/template-web.js"></script>
		
	</head>

	<body>
		<div class="mui-content" id="refreshContainer">
			<div id="userInfo"></div>
		    <!--template begin-->
		    <script id="userInfoTemplate" type="text/html">
		    	<!--header begin-->
			    <div class="header">
			    	<!--phone begin-->
			    	<span class="phone">{{phone}}</span>
			    	<!--phone end-->
	
					<!--balance begin-->
					<span class="balance">
						总金币
						<span>{{balance}}</span>
						&nbsp;
						枚
					</span>
			    	<!--balance end--> 
			    </div>
			    <!--header end-->
			    
			    <!--info begin-->
		    	<div class="info mui-content">
		    		<div class="mui-row">
		    			<div class="mui-col-sm-6 mui-col-xs-6 col"><label class="item-title">可使用金币(枚)</label></div>
		    			<div class="mui-col-sm-6 mui-col-xs-6 col"><label class="item-title">已冻结金币(枚)</label></div>
		    		</div>
		    		<div class="mui-row">
		    			<div class="mui-col-sm-6 mui-col-xs-6 col"><label class="item-content">{{canWithdrawAmount}}</label></div>
		    			<div class="mui-col-sm-6 mui-col-xs-6 col"><label class="item-content">{{canNotWithdrawAmount}}</label></div>
		    		</div>
		    	</div> 
		    	<!--info end-->
		    </script>
		    <!--template end-->
	    	
	    	<!--list begin-->
	    	<div class="form-placeholder-20"></div>
	    	<div class="pannel">
	    		<ul class="mui-table-view settings">
	    			<li class="mui-table-view-cell mui-media">
		    	        <a href="javascript:;" id="messageButton">
		    	            <img style="margin-top: 5px;"  class="mui-media-object mui-pull-left" src="../images/message.png">
		    	            <div class="mui-media-body">
	    	                	短消息
		    	            	<span class="mui-icon mui-icon-arrowright mui-pull-right pannel-right-icon"></span>
		    	            </div>

		    	        </a>
		    	    </li>
		    	    <li class="mui-table-view-cell mui-media">
		    	        <a href="javascript:;" id="updatePasswordButton">
		    	            <img style="margin-top: 5px;"  class="mui-media-object mui-pull-left" src="../images/if_Paul-16_2534330.png">
		    	            <div class="mui-media-body">
	    	                	修改密码
		    	            	<span class="mui-icon mui-icon-arrowright mui-pull-right pannel-right-icon"></span>
		    	            </div>

		    	        </a>
		    	    </li>
		    	    <li class="mui-table-view-cell mui-media">
		    	        <a href="javascript:;" id="customServiceButton">
		    	            <img style="margin-top: 5px;" class="mui-media-object mui-pull-left" src="../images/if_04_Costumer_Care_1871421.png">
		    	            <div class="mui-media-body">
		    	              	联系客服
		    	            	<span class="mui-icon mui-icon-arrowright mui-pull-right pannel-right-icon"></span>
		    	            </div>
		    	        </a>
		    	    </li>
		    	    
		    	    <li class="mui-table-view-cell mui-media">
		    	        <a href="javascript:;" id="logoutButton">
		    	            <img style="margin-top: 5px;" class="mui-media-object mui-pull-left" src="../images/quit.png">
		    	            <div class="mui-media-body" >
		    	              	注销登录
		    	            </div>
		    	        </a>
		    	    </li>
		    	</ul>
	    	</div>
	    	<!--list end-->
			
		    <!--bottom navigation begin-->
			<div class="bottom-navigation-style"></div>
		    <!--bottom navigation end-->
		</div>
		
		<script src="../js/mui.min.js"></script>
		<script src="../js/config.js"></script>
		<script src="../js/common/money.js"></script>
		<script src="../js/app.js"></script>
		<script type="text/javascript">
			
			var gDoc;
			
			(function($, doc) {
				
				gDoc = doc;
				
				$.init({
					pullRefresh : {
					    container:"#refreshContainer",//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
					    down : {
					      style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					      color:'#2BD009', //可选，默认“#2BD009” 下拉刷新控件颜色
					      height:'50px',//可选,默认50px.下拉刷新控件的高度,
					      range:'100px', //可选 默认100px,控件可下拉拖拽的范围
					      offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
					      auto: true,//可选,默认false.首次加载自动上拉刷新一次
					      contentdown : "下拉可以刷新",//可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
					      contentover : "释放立即刷新",//可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
					      contentrefresh : "正在刷新...",//可选，正在刷新状态时，下拉刷新控件上显示的标题内容
					      callback :refreshUserInfo //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					    }
				  	}
				});
				
				
				// 设置个人信息初始值
				var data = {
					phone: "...",
					balance: "...",
					canWithdrawAmount: "...",
					canNotWithdrawAmount: "..."
				}
				var html = template("userInfoTemplate",data);
				doc.getElementById("userInfo").innerHTML = html;
				  
				
				$.plusReady(function() {
					var customServiceButton = doc.getElementById("customServiceButton"),
						updatePasswordButton = doc.getElementById("updatePasswordButton"),
						messageButton = doc.getElementById("messageButton"),
						logoutButton = doc.getElementById("logoutButton");
					
					plus.nativeUI.closeWaiting();
					
					
					// 刷新
					plus.webview.currentWebview().addEventListener("show", function(){
						plus.nativeUI.closeWaiting();
						console.log("刷新")
						refreshUserInfo();
					})
					
					// 短消息
					messageButton.addEventListener("tap", function(){
						mui.openWindow({
		                    url: "/html/messages.html",
		                    id: "messages",
		                    preload: false,
		                    waiting: {
		                        autoShow: true,
	                          title:'正在加载...'
		                    },
						    createNew:true
		    
		                });
					}, false)
					
					
					// 修改密码
					updatePasswordButton.addEventListener("tap", function(){
						plus.webview.open('/html/update-password.html', 'new', {}, 'slide-in-right', 200);
					}, false)
					
					// 联系客服
					customServiceButton.addEventListener("tap", function(){
						mui.openWindow({
		                    url: "/html/custom-service.html",
		                    id: "custom-service",
		                    preload: false,
		                    waiting: {
		                        autoShow: true,
	                          title:'正在加载...'
		                    },
						    createNew:true
		    
		                });
					}, false)
					
					// 注销登录
					logoutButton.addEventListener("tap", function(){
						var localCache = plus.storage.getItem('userInfo');
						if(localCache != null && localCache.length > 0){ 
							app.logout({
								"token": JSON.parse(localCache).token.toString()
							}, function(data){
								toLogin($);
							}, function(){
								toLogin($);
							})
						}else{
							toLogin($);
						}
					}, false)
					 
				});
			}(mui, document));
			
			
			/**
			 * 刷新用户信息
			 */
			function refreshUserInfo(){ 
				var localCache = plus.storage.getItem('userInfo');
				app.getUserDetailInfo({
					"token": JSON.parse(localCache).token.toString()
				}, function(data){
					mui('#refreshContainer').pullRefresh().endPulldown();

					if(data == null || data.code == null || data.code == 500 || data.code == 300){
						plus.nativeUI.toast("刷新失败");
						return false;
					}
					
					if(data.code == 400){
						plus.nativeUI.toast(data.msg);
						return false;
					}
					
					
					// 格式化信息
					var oldJson = data.msg;
					var newJson = oldJson;
					newJson.balance =  window.moneyUtil.dealNumber(newJson.balance);
					newJson.canWithdrawAmount  = window.moneyUtil.dealNumber(newJson.canWithdrawAmount);
					newJson.canNotWithdrawAmount  = window.moneyUtil.dealNumber(newJson.canNotWithdrawAmount);
					
					var html = template("userInfoTemplate", newJson);
					gDoc.getElementById("userInfo").innerHTML = html;
					
					
					plus.storage.setItem('userInfo', JSON.stringify(data.msg));
					
					  
					
				}, function(){
					mui('#refreshContainer').pullRefresh().endPulldown();
					plus.nativeUI.toast("服务器开小差了,请您稍后重试!");
				})
				
			}
			
			/**
			 * 跳转登录页
			 * @param {Object} $
			 */
			function toLogin($){
				plus.storage.setItem('userInfo','');
				plus.storage.setItem('isAutoLogin','false');
				$.openWindow({
					url: '/login.html',
					id: 'login',
					preload: true,
					show: {
						aniShow: 'pop-in',
						duration: 200
					},
					styles: {
						popGesture: 'hide'
					},
					waiting: {
						title: "正在加载...",
						autoShow: true
					}
				});
			}
		</script>
	</body>

</html>