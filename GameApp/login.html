<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/animate.min.css" />
		<link href="css/ui.css" rel="stylesheet" /> 
		<link href="css/login.css" rel="stylesheet" /> 
	</head>
	<body>
		
		<!--container begin-->
		<div class="container">
			<div class="header">
				<!--logo begin-->
				<span style="color: #fff;" id="title"></span>
				<!--logo end-->
			</div>
			<div class="form-placeholder-30"></div>
			
			<!--username begin-->
			<div class="form-item form-item-full">
				<input type="text" class="form-input" id="phone" placeholder="手机号" value="17854141391"/>
			</div>
			<!--username end-->
			
			
			<!--password begin-->
			<div class="form-item form-item-full">
				<input type="password" class="form-input" id="password" placeholder="密码" value="123456"/>
			</div>
			<!--password end-->
			
			
			<!--login button begin-->
			<div class="form-placeholder-20"></div>
			<div class="form-item">
				<button id='loginButton' class="mui-btn mui-btn-block mui-btn-orange">登&nbsp;&nbsp;录</button>
			</div>
			<!--login button end-->
			 
		</div>
		<!--container end-->
		
		<!--footer begin-->
		<div class="form-placeholder-50"></div>
		<footer>
			<span><a href="javascript:void(0)" id="registerButton">立即注册></a></span>
		</footer>
		<!--footer end-->
		

		<script src="js/mui.min.js"></script>
		<script src="js/mui.enterfocus.js"></script>
		<script src="js/config.js"></script>
		<script src="js/app.js"></script>
		<script>
			document.getElementById("title").innerText = window.config.title;
			
			(function($, doc) {
				$.init({
					statusBarStyle: "light",
					statusBarBackground: '#fe5a2f',
					keyEventBind: {
						backbutton: false  //关闭back按键监听
					}
				});
				 
				
				$.plusReady(function() {
					
					// 设置顶部状态栏样式
					plus.navigator.setStatusBarStyle("light");
					plus.navigator.setStatusBarBackground("#FE532A");
					
					// 禁止屏幕翻转
					plus.screen.lockOrientation("portrait-primary");
					 
					var loginButton = doc.getElementById('loginButton'),
						registerButton = doc.getElementById('registerButton'),
						phoneInput = doc.getElementById('phone'),
						passwordInput = doc.getElementById('password');
					 
					
					
					// 检查用户是否已登录
					isLogin($);
					
					var self = plus.webview.currentWebview();
					self.addEventListener("show", function(){
						console.log("注册页返回的信息" + JSON.stringify(self))
						if(self.phone != null){
							phoneInput.value = self.phone;
						}
						
						var userInfo = plus.storage.getItem('userInfo');
						if(userInfo != null){
							phoneInput.value = JSON.parse(userInfo).phone;
						}
					})
					
					/**
					 * 注册
					 */
					registerButton.addEventListener('tap', function(event) {
						$.openWindow({
							url: 'register.html',
							id: 'register',
							preload: true,
							show: {
								aniShow: 'pop-in',
								duration: 200
							},
							styles: {
								popGesture: 'hide'
							},
							waiting: {
								title: "正在加载...",
								autoShow: true
							}
						});
					}, false);
				
					
					/**
					 * 登录
					 */
					loginButton.addEventListener("tap",function(){
						loginButton.disabled = true;
						loginButton.classList.add("button-disabled");
						
						app.login({
							phone: phoneInput.value,
							password: passwordInput.value
						}, function(data){
							if(data == null || data.code == null || data.code == 500 || data.code == 300){
								plus.nativeUI.toast("登录失败");
								loginButton.disabled = false;
								loginButton.classList.remove("button-disabled");
								return false;
							}
							
							if(data.code == 400){
								loginButton.disabled = false;
								loginButton.classList.remove("button-disabled");
								plus.nativeUI.toast(data.msg);
								return false;
							}
							
							plus.nativeUI.toast("登录成功");
							loginButton.disabled = false;
							loginButton.classList.remove("button-disabled");
							
							plus.storage.setItem('userInfo', JSON.stringify(data.msg));
							plus.storage.setItem('isAutoLogin', "true");
							
							console.log(data.msg.token)
							
							toHome($);
							
						}, function(){
							loginButton.disabled = false;
							loginButton.classList.remove("button-disabled");
							plus.nativeUI.toast("登录失败");
						})
					}, false) 
				});
			}(mui, document));
			
			
			/**
			 * 用户是否登录
			 */
			function isLogin($){
				var localCache = plus.storage.getItem('userInfo');
				var isAutoLogin = plus.storage.getItem('isAutoLogin');
				if(isAutoLogin == null || isAutoLogin != "true") localCache =  null;
				console.log("自动登录:" + localCache);
				if(localCache != null && localCache.length > 0){
					app.getUserInfo({
						"token": JSON.parse(localCache).token.toString()
					}, function(data){
						if(data.code == 200){
							 toHome($);
						}else{
							plus.nativeUI.toast("自动登录失败");
						}
					}, function(){ })
				}
			}
			
			
			/**
			 * 跳转到首页
			 */
			function toHome($){
				$.openWindow({
					url: 'index.html',
					id: 'index',
					preload: true,
					show: {
						aniShow: 'pop-in',
						duration: 200
					},
					styles: {
						popGesture: 'hide',
						/*titleNView: {
						    type:'transparent',//透明渐变样式
						}*/
					},
					waiting: {
						title: "正在加载...",
						autoShow: true
					}
				});
			}
		</script>
	</body>

</html>